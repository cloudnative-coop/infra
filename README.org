#+title: infra

#+begin_quote
a Flux + Terraform infrastructure repo
#+end_quote

* Todo

- [x] add Flux for cloudnative-coop repo
- [x] get talosconfig
- [ ] access Kubernetes APIServer
- [ ] verify Ceph disk allocation

* Prerequisites

Install OpenTofu

#+begin_src shell
brew install opentofu
#+end_src

* Usage

plan

#+begin_src shell
tofu destroy -var equinix_metal_project_id=$METAL_PROJECT_ID -var equinix_metal_auth_token=$METAL_AUTH_TOKEN
#+end_src

apply

#+begin_src shell
tofu apply -var equinix_metal_project_id=$METAL_PROJECT_ID -var equinix_metal_auth_token=$METAL_AUTH_TOKEN
#+end_src

get talosconfig

#+begin_src shell :results silent
tofu output -raw cloudnative-coop-talosconfig > ~/.talos/config-cloudnative-coop
#+end_src

get kubeconfig

#+begin_src shell :results silent
tofu output -raw cloudnative-coop-kubeconfig > ~/.kube/config-cloudnative-coop
#+end_src

* Flux usage

bootstrap a cluster

#+begin_src shell :results silent
KUBECONFIG=~/.kube/config-cloudnative-coop
CLUSTER=PATH=clusters/cloudnative.coop
flux \
    --kubeconfig "$KUBECONFIG" \
    bootstrap \
    git \
    --url=ssh://git@github.com/ii/infra.git \
    --path="$CLUSTER_PATH" \
    --components-extra=image-reflector-controller,image-automation-controller
#+end_src

force a reconciliation

#+begin_src shell :results silent
flux --kubeconfig ~/.kube/config-cloudnative-coop reconcile source git flux-system
#+end_src

* Notes

- Equinix Metal Cloud Provider 401 error regarding IP allocation and assigning
